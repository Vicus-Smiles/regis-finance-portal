{% extends 'base.html' %}

{% block content %}
<div class="container">
  <div class="card mt-4 p-4">
    <h3>Expense Report & Analysis</h3>

    <!-- Filter Form -->
    <form method="get" class="row g-3 mb-4">
      <div class="col-md-3">
        {{ form.start_date.label_tag }} {{ form.start_date }}
      </div>
      <div class="col-md-3">
        {{ form.end_date.label_tag }} {{ form.end_date }}
      </div>
      <div class="col-md-3">
        <button class="btn btn-dark">Filter</button>
      </div>
    </form>
    <a href="{% url 'dashboard_export_expenses_excel' %}" class="btn btn-success mb-3">ðŸ“¥ Export to Excel</a>


    <!-- Expenses Table -->
    <table class="table table-bordered table-striped table-sm">
      <thead class="table-dark">
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th>Amount (UGX)</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {% for e in expenses %}
        <tr>
          <td>{{ e.date }}</td>
          <td>{{ e.category }}</td>
          <td>{{ e.amount }}</td>
          <td>{{ e.description }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center">No expenses recorded for this period.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pie Chart -->
  <div class="card mt-4 p-4">
    <h5>Expense Breakdown by Category</h5>
    <canvas id="expenseChart" width="400" height="150"></canvas>
  </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('expenseChart').getContext('2d');
  const expenseChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: [
        {% for item in grouped %}
          "{{ item.category }}", 
        {% endfor %}
      ],
      datasets: [{
        label: 'UGX Spent',
        data: [
          {% for item in grouped %}
            {{ item.total }},
          {% endfor %}
        ],
        backgroundColor: [
          'rgba(255, 99, 132, 0.6)',
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 206, 86, 0.6)',
          'rgba(75, 192, 192, 0.6)',
          'rgba(153, 102, 255, 0.6)',
          'rgba(255, 159, 64, 0.6)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true
    }
  });
</script>
{% endblock %}
